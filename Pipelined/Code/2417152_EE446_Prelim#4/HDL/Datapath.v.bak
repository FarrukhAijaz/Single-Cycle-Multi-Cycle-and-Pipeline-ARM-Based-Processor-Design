	// Datapath.v
module DataPath(
    input clk,
	 input reset, 
	 input PCSrcW,
	 input BranchTakenE,
	 
	 
	 //for debugging
	 input [3:0] Switches,
	 output [31:0] HEX_Debug,
	 output [31:0] PC_Out
	 
);


wire [31:0] MUX0_Out;
wire [31:0] MUX7_Out;

wire [31:0] Instr;
wire [31:0] ResultW;
wire [31:0] PC_prime;

wire [31:0] ALUResultE;

wire [31:0] Const_Four;
wire [3:0] Const_Fifteen;
wire [3:0] Const_Forteen;
wire Const_Zero;
wire Const_One;

wire [31:0] PCPlus4F;
wire [31:0] PCF;
wire [31:0] PCPlus4FWB_Out;

wire [31:0] PCPlus4FM_Out;
wire [31:0] PCPlus4FE_Out;

wire [31:0] RD1D;
wire [31:0] RD2D;

wire [31:0] ExtImmD;
wire [31:0] ExtImmE;

Mux_2to1 #(32) MUX0 
	(
        .input_0(PCPlus4F),
        .input_1(ResultW),
        .select(PCSrcW),
        .output_value(MUX0_Out)
    );
//done
Mux_2to1 #(4) MUX1 
	(
        .input_0(MUX0_Out),
        .input_1(ALUResultE),
        .select(BranchTakenE),
        .output_value(PC_prime)
    );
//done

Register_rsten  #(32) Fetch_Pipeline_Register

(
		.clk(clk), 
		.reset(reset),
		.we(~StallF),
		.DATA(PC_prime),
		.OUT(PCF)
);

Instruction_memory  #(4,32) IM_Fetch 
(
	.ADDR(PCF),
	.RD(InstructionF)
);

Adder #(32) My_Adder
(
	.DATA_A(PCF),
	.DATA_B(Const_Four),
	.OUT(PCPlus4F)
);

Register_rsten  #(32) Decode_Pipeline_Register 

(
		.clk(clk), 
		.reset(FlushD),
		.we(StallD),
		.DATA(InstructionF),
		.OUT(InstructionD)
);

Register_rsten  #(32) Decode_Pipeline_Register_PC 

(
		.clk(clk), 
		.reset(FlushD),
		.we(StallD),
		.DATA(PCF),
		.OUT(PCD)
);
Mux_2to1 #(4) MUX2 
	(
        .input_0(InstructionD [19:16]),
        .input_1(Const_Fifteen),
        .select(RegSrcD[0]),
        .output_value(RA1D)
    );
//done
Mux_2to1 #(4) MUX3 
	(
        .input_0(InstructionD [3:0]),
        .input_1(InstructionD [15:12]),
        .select(RegSrcD[1]),
        .output_value(RA2D)
    );
//done
Mux_2to1 #(32) MUX4
	(
        .input_0(WA3W),
        .input_1(Const_Forteen),
        .select(BL_ctrl),
        .output_value(WA3D)
    );
//done
Mux_2to1 #(32) MUX5 
	(
        .input_0(ResultW),
        .input_1(PCPLus4FWB_Out),
        .select(BL_ctrl),
        .output_value(WD3)
    );
//done

Register_file  #(32) My_RegFile 

(
		.clk(clk), 
		.write_enable(RegWriteW), 
		.reset(Const_Zero),
		.Source_select_0(RA1D), 
		.Source_select_1(RA2D), 
		.Debug_Source_select(Switches), 
		.Destination_select(WA3D),
		.DATA(WD3), 
		.Reg_15(PCPlus4F),
		.out_0(RD1D), 
		.out_1(RD2D), 
		.Debug_out(HEX_Debug)
);
//done
Extender My_Extender 
		(
			.Extended_data(ExtImmD),
			.DATA(InstructionD [23:0]),
			.select(ImmSrcD)
		);
//done

Register_reset  #(32) RD1_Decode_to_Execute

(
		.clk(clk), 
		.reset(),
		.DATA(RD1D),
		.OUT(RD1E)
);

Register_reset  #(32) RD2_Decode_to_Execute

(
		.clk(clk), 
		.reset(),
		.DATA(RD2D),
		.OUT(RD2E)
);

Register_reset  #(4) WA3D_Decode_to_Execute

(
		.clk(clk), 
		.reset(),
		.DATA(WA3D),
		.OUT(WA3E)
);



Register_reset  #(4) ExtImmD_Decode_to_Execute

(
		.clk(clk), 
		.reset(),
		.DATA(ExtImmD),
		.OUT(ExtImmE)
);

Register_reset  #(4) PCPlus4FD_Decode_to_Execute

(
		.clk(clk), 
		.reset(),
		.DATA(PCD),
		.OUT(PCE)
);



Mux_4to1 #(32) MUX6 
	(
        .input_0(RD1E),
        .input_1(ResultW),
		  .input_2(ALUOutM),
		  .input_3(Const_Zero),
        .select(ForwardAE),
        .output_value(SrcAE)
    );
//done
Mux_4to1 #(32) MUX7 
	(
        .input_0(RD2E),
        .input_1(ResultW),
		  .input_2(ALUOutM),
		  .input_3(Const_Zero),
        .select(ForwardBE),
        .output_value(MUX7_Out)
    );
//done
Mux_2to1 #(32) MUX8 
	(
        .input_0(MUX7_Out),
        .input_1(ExtImmE),
        .select(ALUSrcE),
        .output_value(shift_input)
    );

shifter #(32) My_Shifter 
		(
			.control(Instr [6:5]),
			.shamt(Instr [11:7]),
			.DATA(shift_input),
			.OUT(shift_output)
		);
	 
ALU #(32) My_ALU 
	(
		.control(ALUControlE),
		.CI(Const_Zero),
		.DATA_A(SrcAE),
		.DATA_B(SrcBE),
		.OUT(ALUResultE),
		.CO(ALUFlags [3]),
		.OVF(ALUFlags [2]),
		.N(ALUFlags [1]), 
		.Z(ALUFlags [0])
	);


Mux_2to1 #(32) MUX9 
	(
        .input_0(ReadDataW),
        .input_1(ALUOutW),
        .select(MemtoRegW),
        .output_value(ResultW)
    );





Register_file  #(32) reg_file_dp 

(
		.clk(clk), 
		.write_enable(RegWrite), 
		.reset(Const_Zero),
		.Source_select_0(RA1), 
		.Source_select_1(RA2), 
		.Debug_Source_select(Switches), 
		.Destination_select(A3),
		.DATA(WD3), 
		.Reg_15(Result + 4),
		.out_0(RD1), 
		.out_1(RD2), 
		.Debug_out(HEX_Debug)
);




 

Constant4 #(32,4)My_Constant_Four
(
	.const_value(Const_Four)
);
Constant4 #(4,15)My_Constant_Fifteen
(
	.const_value(Const_Fifteen)
);
Constant4 #(4,14)My_Constant_Forteen
(
	.const_value(Const_Forteen)
);
Constant4 #(32,0)My_Constant_Zero
(
	.const_value(Const_Zero)
);

assign Cond = Instr [31:28];
assign Op = Instr [27:26];
assign Funct = Instr [25:20];
assign Rd = Instr [15:12];
assign PC_prime = Result;
assign SrcB = shift_output;
assign PC_Out = PC1;
endmodule
